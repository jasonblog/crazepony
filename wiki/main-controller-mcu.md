
#  飛行器控制器——主控MCU


## 四軸的靈魂——飛控
飛控是四軸的靈魂。那麼什麼是飛控呢？飛控其實就是四軸飛行器的電子控制部分，包括傳感器部分**慣性導航模塊**和控制部分的MCU。
 
四軸飛行器相對於常規航模來說，最複雜的就是電子部分。可以和其它兩種常見的航模固定翼以及直升機比較一下。在常規固定翼航模上，陀螺儀並非常用器件。相對操控難度大點的直升級航模，如果不做自動穩定系統，也只是鎖尾才用到陀螺儀。四軸飛行器則必須配備陀螺儀，這是最基本要求，不然無法飛行，更談不上飛穩了。不但要有，還得是3軸(X、Y、Z)都得有，這是四軸飛行器的機械結構、動力組成特性決定的。在此基礎上再輔以3軸加速度傳感器，這6個自由度，就組成了飛行姿態穩定的基本部分，也是關鍵核心部分**慣性導航模塊**，簡稱IMU。飛行中的姿態感測全靠這個IMU了，可見它是整架模型的核心部件。

IMU感知飛行器在空中的姿態，將數據送給處理器MCU。處理器MCU將根據用戶操作的指令，以及IMU數據，通過飛行算法控制飛行器的穩定運行。由於有大量的數據需要計算，而且需要實時性極高的控制，所以MCU的性能也決定了飛行器是否能夠飛得足夠穩定，靈活。

本篇文章只講飛控的MCU部分，將有另外一篇文章《飛控——傳感器》講解IMU部分內容。


## 主控MCU STM32
Crazepony的主控MCU選用的是意法半導體的STM32f103T8U6，為32位ARM Cortex-M內核，最高72MHz。關於為什麼會選用這片MCU，在CamelGo的博客[我和Crazepony的那點事兒(2)](http://www.crazepony.com/2014/05/29/story-with-crazepony-2.html)中有這麼一段描述。

![](/assets/img/STM32.jpg)

>曾經在猶豫用TI的430系列單片機還是意法半導的STM32。那是在我大二的時候，從來沒有接觸過STM32，以前都是用51單片機和TI的msp430系列單片機。好吧，我承認了，我做Crazepony其實是就是為了學習STM32的，沒有買過STM32相關的開發板，就這麼簡單粗暴大刀闊斧的開始了我的STM32之旅…
>
>最終選擇用STM32當然還有其他原因，TI公司的MSP430系列都是基於低功耗在做文章，作為移動消費電子，對電源續航能力要求比較高的場合比較適用。
>
>……
>
>之所以選擇STM32F103T8U6作為Crazepony的主控芯片。首先因為他是crotex-M3內核，繼承了ARM的優良性能，主頻能跑到72MHz，3個通用定時器，1個高級定時器，7通道DMA控制器，而且總線接口資源豐富；其次是因為它VFQFPN36的封裝，只有6mm*6mm的佔地面積,對這個寸土寸金的項目來說簡直太讚了。這麼高的性價比，當然讓我選擇了他作為主控。72MHz雖然生不了孩紙，但是足以處理除了圖像之外的大部分任務了。

## 主控選型需要考慮的問題
CamelGo說是誤打誤撞就選用了STM32作為主控MCU，其實真正在選型時候，有很多問題是需要我們考慮的，下面列舉出幾個最常見的問題。

* 首先是MCU的性能，最重要的指標就是主頻。這直接決定MCU計算的快慢。四軸飛行器有很多來自IMU的數據需要處理，而且還有複雜的控制算法，如果MCU的性能不夠，那麼將直接限制飛控只能夠處於一個比較初級的階段，無法完成更加複雜的功能和精準的控制；
* MCU的接口也很重要。MCU是整個四軸飛行器的大腦，幾乎所有的數據都要連接到它上面。例如I2C總線個數，DMA通道數目，GPIO數據等等；
* 正如博客中提到的，MCU的尺寸大小也是值得考慮的因素；
* 另外就是這個MCU的開發是否簡單，技術資源的支持是否足夠多。這對於一個DIY的開源四周飛行器也很重要；

綜合了這些因素，我們選擇了STM32這片MCU作為我們的主控MCU。我們也高興的看到，很多國內國外的四軸愛好者也選擇了這一片MCU。Crazepony不再孤獨！

## 關於ARM Cortex-M
由於STM32使用的是ARM Cortex-M架構，所以這裡有必要做一點ARM Cortex的普及。

ARM公司在經典處理器ARM11架構之後，為了給不同需求的CPU廠商提供服務，之後的內核架構命名都改為Cortex，並分成了A,R,M三類,也即將ARM的三個字母拆分為三個架構的名，代表著不同的發展方向：

* A系列處理器可託管豐富的OS平臺和位應用商提供全方位的解決方案，諸如低成本手機、數字電視、機頂盒、打印機、服務器等。
* R系列為實時處理器，要求可靠性、可用性、可維護性和實時響應的嵌入式系統提供解決方案。
* M系列是一系列可向上兼容的高效能、易於使用的處理器，這些處理器旨在幫助開發者滿足將來嵌入式的需要，這些需要包括低成本、不斷增加的連接、代碼改善移植等。M系列主要應用在智能測量、人機接口設備、汽車電子、工業控制、大型家電等。

所以，我們的STM32使用的Cortex-M3內核，就屬於ARM的M系列，主要針對嵌入式產品需求而設計的。下面是一張Cortex-M3的內核架構圖。

![](/assets/img/Cortex-M3-chip-diagram-LG.png)

